/*!
 * Paylocker addon, 2017-04-11 
 * for Social Locker platform: https://sociallocker.ru 
 * 
 * Copyright 2017, Alex Kovalev, Pavel Kashtanof, <alex.kovalevv@gmail.com> 
 * Support: https://sociallocker.ru/create-ticket/ 
 * 
 * Дополнение построено на платформе социального замка, выполняет блокирование платного контента. Есть возможность генерации тарифных таблиц, пошаговой регистрации и оплаты.*/

!function(a){"use strict";a.pandalocker.controls["pricing-tables"]||(a.pandalocker.controls["pricing-tables"]={});var b=a.pandalocker.tools.extend(a.pandalocker.entity.actionControl);b.name="tables",b.defaults={ajaxUrl:null,paymentType:"subscribe",paymentWay:"screen",paymentRedirectUrl:null,paymentForms:{yandex:{}}},b.prepareOptions=function(){this.options=a.extend(!0,this.defaults,this.options,this.locker.options.paylocker),this.redirectUrl=this.options.paymentRedirectUrl},b.paymentProcess=function(b,c,d){if(!c||!b)throw new Error("Не передан обязательный параметр tableName или transactionId");var e=this.options.paymentForms.yandex;d?e.description=a.pandalocker.lang.pl_payment_form_newuser_description:"subscribe"==this.options.paymentType?e.description=a.pandalocker.lang.pl_payment_form_subscription_description:"purchase"==this.options.paymentType&&(e.description=a.pandalocker.lang.pl_payment_form_purchase_description),e.targets=a.pandalocker.lang.pl_payment_form_purchase_target,"subscribe"==this.options.paymentType&&(e.targets=a.pandalocker.lang.pl_payment_form_subscribe_target),this.options[c].header&&(e.targets+=" «"+this.options[c].header+"»"),e.label=b,e.sum=this.options[c].price,this.locker._showScreen("paylocker-yandex-form",e)},b.showScreenEmail=function(b){var c=this;c.locker._showScreen("enter-email",{header:"",message:a.pandalocker.lang.pl_confirm_email_description,buttonTitle:a.pandalocker.lang.pl_confirm_email_text_button,callback:function(d){a.pandalocker.tools.setStorage("opanda_email",d,30),c.beginTransaction(b,{email:d},!1)}});var d=a.pandalocker.tools.getFromStorage("opanda_email"),e=a("#onp-sl-input-email");""==e.val()&&d&&e.val(d)},b.beginTransaction=function(b,c){var d=this,e=this.locker.options.ajaxUrl||this.options.ajaxUrl;if(!e||!b)throw new Error("Не передан обязательный параметр proxy или tableName");d.locker._showScreen("data-processing");var f=window.bizpanda&&window.bizpanda.lockerOptions[this.locker.options.id]?window.bizpanda.lockerOptions[this.locker.options.id]:{};f||(d.locker._showScreen("paylocker-error"),console&&console.log("[Error]: Не переданы настройки замка"));var g=a.extend(!0,{action:"onp_pl_begin_transaction",locker_id:f.lockerId,post_id:f.postId,table_payment_type:this.options[b].paymentType,table_name:b,table_price:this.options[b].price,force_register_user:!1},c),h=a.pandalocker.tools.getFromStorage("onp_pl_begin_transaction");h&&h.table_name==g.table_name&&h.locker_id==g.locker_id&&(g.transaction_id=h.transaction_id),a.ajax({type:"POST",dataType:"json",url:e,data:g,success:function(c){return console.log(c),!c||c&&c.error?void d.locker._showScreen("paylocker-error",{errorMessage:c.error}):c.warning&&"entry_email"==c.code?void d.showScreenEmail(b):c.warning&&"email_not_exists"==c.code?void d.locker._showScreen("prompt",{textMessage:a.pandalocker.lang.pl_promt_email_not_exists,textButtonYes:a.pandalocker.lang.pl_promt_email_not_button_yes,textButtonNo:a.pandalocker.lang.pl_promt_email_not_button_no,callbackButtonYes:function(){g.force_register_user=!0,d.beginTransaction(b,g)},callbackButtonNo:function(){d.showScreenEmail(b)}}):void(c.transaction_id&&(a.pandalocker.tools.setStorage("onp_pl_begin_transaction",{transaction_id:c.transaction_id,table_name:b,locker_id:g.locker_id},1),d.paymentProcess(c.transaction_id,b,c.newUser)))},error:function(a,b,c){a&&a.readyState<4||(d.locker._showScreen("paylocker-error"),console&&console.log&&(console.log("Invalide ajax response:"),console.log(a.responseText)))}})},b.createTable=function(b,c){var d=this,e=c.header||a.pandalocker.lang.pl_ctable_header,f=c.price||a.pandalocker.lang.pl_ctable_price,g=c.description||a.pandalocker.lang.pl_ctableDescription,h=c.buttonText||a.pandalocker.lang.pl_ctable_button_text,i=c.afterButtonText||a.pandalocker.lang.pl_ctable_after_button_text,j=a('<div class="onp-pl-control-table onp-pl-'+c.paymentType+'"></div>'),k=a('<h3 class="onp-pl-ctable-header '+c.paymentType+'">'+e+"</h3>"),l=a('<div class="onp-pl-ctable-price">'+f+'<span class="onp-pl-ctable-currency">р.</span></div>'),m=a('<div class="onp-pl-ctable-description">'+g+"</div>"),n=a('<button class="onp-pl-ctable-button '+c.paymentType+'">'+h+"</button>"),o=a('<div class="onp-pl-ctable-after-button-text">'+i+"</div>");return j.append(k).append(l),j.append(m).append(n).append(o),n.click(function(){d.beginTransaction(b);var c=a(this).closest(".onp-sl-paylocker");a("html, body").animate({scrollTop:c.offset().top-100},400)}),j},b.createSeparator=function(){var b=a('<div class="onp-pl-control-separator">--- ИЛИ ---</div>');return b},b.render=function(c){if(!this.groupOptions.orderTables.length)return void c.append('<div class="onp-pl-tables-not-found" style="color: #ff3100;font-weight: bold; text-align: center;">'+a.pandalocker.lang.pl_table_not_found+"</div>");for(var d=a('<div class="onp-pl-tables-contanier"></div>'),e=0;e<this.groupOptions.orderTables.length;e++){var f=this.groupOptions.orderTables[e];if(!this.options[f])return void this.showError("pricing-table",a.pandalocker.lang.pl_errors.tarif_not_found.replace("{tarif_name}",f));if("separator"==this.options[f].itemType){var g=b.createSeparator();d.append(g)}else{var h=this.createTable(f,this.options[f]);d.append(h)}}c.append(d)},b.targetsReminder=function(){var b=this,c=a.pandalocker.tools.getFromStorage("onp_pl_begin_transaction");c&&this.locker._showScreen("prompt",{textMessage:a.pandalocker.lang.pl_prompt_reminde_subscribe_message,textButtonYes:a.pandalocker.lang.pl_prompt_reminde_subscribe_button_yes,textButtonNo:a.pandalocker.lang.pl_prompt_reminde_subscribe_button_no,callbackButtonYes:function(){return b.paymentProcess(c.transaction_id,c.table_name),!1},callbackButtonNo:function(){b.locker._showScreen("default"),a.pandalocker.tools.removeStorage("onp_pl_begin_transaction")}})},a.pandalocker.controls["pricing-tables"].tables=b}(jQuery);;
!function(a){"use strict";var b=a.pandalocker.tools.extend(a.pandalocker.entity.group);b._defaults={order:["tables"],text:a.pandalocker.lang.subscription.defaultText},b.name="pricing-tables",a.pandalocker.groups["pricing-tables"]=b}(jQuery);;
!function(a){"use strict";var b={pl_payment_form_header:"Оплата премиум доступа",pl_payment_form_newuser_description:"На ваш email адрес выслано письмо с интсрукциями по получению доступа к вашему аккаунту. Пожалуйста, завершите оплату.",pl_payment_form_subscription_description:"После оплаты ваш аккаунт перейдет в статус премиум подписчика, все замки будут сняты.",pl_payment_form_purchase_description:"После оплаты статьи, замок с нее будет снят. Ссылки на приобретенные вами статьи будет в личном кабинете пользователя.",pl_payment_form_subscribe_target:"Оформление премиум подписки",pl_payment_form_purchase_target:"Покупка одной статьи",pl_payment_form_target_label:"Назначение платежа",pl_payment_form_price_label:"Сумма",pl_payment_form_way_label:"Способ оплаты",pl_payment_form_terms:'C <a href="{%terms_url%}" target="_blank">условиями оплаты</a> ознакомлен',pl_payment_form_process:"Пожалуйста, подождите... Мы проверяем ваш платеж.",pl_separatorText:"----- ИЛИ -----",pl_confirm_email_description:"Пожалуйста, введите свой email. Мы создадим для вас аккаунт на нашем сайте или обновим премиум доступ у ранее созданного аккаунта.",pl_confirm_email_text_button:"Подтвердить",pl_table_not_found:"Вы не создали еще не одного тарифа. Пожалуйста, настройте тарифы в панели управления.",pl_ctable_header:"Название тарифа",pl_ctable_price:"Цена не установлена",pl_ctable_discount:"СКИДКА {%discount%}",pl_ctable_description:"Текст перед кнопкой",pl_ctable_button_text:"Оформить подписку",pl_ctable_after_button_text:"Текст после кнопки",pl_prompt_reminde_subscribe_message:"Вы начали, но не завершили подписку на премием доступ к контенту сайта!<br> Желаете перейти к оплате или отменить подписку?",pl_prompt_reminde_subscribe_button_yes:"Перейти к оплате",pl_prompt_reminde_subscribe_button_no:"Отменить подписку",pl_promt_email_not_exists:"[email] не зарегистрирован или вы ввели его с ошибкой. Создать новый аккаунт с этим email адресом и привязать к нему вашу покупку?",pl_promt_email_not_button_yes:"Да, создать новый аккаунт",pl_promt_email_not_button_no:"Отмена",pl_errors:{tarif_not_found:"Тариф [{tarif_name}] не настроен.",payment_gateway_not_found:"Платежный путь [{payment_gateway}] не существует."}};a.pandalocker.lang=a.extend(!0,b,a.pandalocker.lang)}(jQuery);;
!function(a){"use strict";a.pandalocker.themes||(a.pandalocker.themes={}),a.pandalocker.themes["default"]={socialButtons:{layout:"horizontal",counter:!1,flip:!1}},a.pandalocker.themes["default-light"]={socialButtons:{layout:"horizontal",counter:!1,flip:!1}},a.pandalocker.themes["default-black"]={socialButtons:{layout:"horizontal",counter:!1,flip:!1}},a.pandalocker.themes["default-forest"]={socialButtons:{layout:"horizontal",counter:!1,flip:!1}},a.pandalocker.hooks.add("opanda-filter-options",function(a,b){return a.paylocker&&(a.locker.close=!1,a.locker.timer=0,a.theme&&"object"==typeof a.theme?a.theme.style&&"default"!=a.theme.style&&(a.theme={name:"default-"+a.theme.style}):a.theme={name:"default"}),a}),a.pandalocker.hooks.add("opanda-before-lock",function(b,c){c.options.paylocker&&c.options.paylocker.helpUrl&&a(c.locker).prepend('<a class="onp-pl-help-link" href="'+c.options.paylocker.helpUrl+'" target="_blank">Помощь</a>'),a(c.locker).append('<div class="onp-pl-bottom-panel"><a href="" class="onp-pl-login-link">Уже подписаны? Тогда войдите</a><a href="mailto:" class="onp-pl-mailto-link">Остались вопросы? Напишите нам.</a><div style="clear: both;"></div></div>')}),a.pandalocker.hooks.add("opanda-init",function(b,c){c._registerScreen("paylocker-success-payment",function(b,c){var d=a('<div class="onp-pl-screen-header">Оплата успешно завершена!</div>');b.append(d);var e=__paylocker&&__paylocker.loginUrl,f=a('<div class="onp-pl-screen-text">Вам остался один шаг, <a href="'+e+'">авторизуйтесь</a> на нашем сайте, чтобы открыть замки. </div>');b.append(f)}),c._registerScreen("paylocker-error",function(b,c){if(c&&c.header){var d=a('<div class="onp-pl-screen-header">'+c.header+"</div>");b.append(d)}var e=c&&c.errorMessage||'Произошла неивестная ошибка во время выполнения запроса. Пожалуйста, свяжитесь с нашей <a href="#">службой поддеддержки</a>, чтобы решить эту проблему.',f=a('<div class="onp-pl-screen-text">'+e+"</div>");b.append(f)}),c._registerScreen("paylocker-yandex-form",function(b,d){var e={termsPageUrl:"#",alternatePaymentTypePageUrl:"#",receiver:null,label:null,sum:null,quickpay:"shop",paymentTypeChoice:!0,writer:"seller",targets:"",targetsHint:"",buttonText:"01",successURL:""};d=a.extend(!0,e,d);if(!d.receiver||""==d.receiver)return void setTimeout(function(){c._showScreen("paylocker-error",{errorMessage:"Не передан account id яндекс денег."})},500);if(!d.sum||""==d.sum)return void setTimeout(function(){c._showScreen("paylocker-error",{errorMessage:"Не установлена сумма платежа."})},500);var f=d.header||a.pandalocker.lang.pl_payment_form_header,g=d.description||a.pandalocker.lang.pl_payment_form_subscription_description,h='<h3 class="onp-pm-screen-header">'+f+"</h3>",i='<div class="onp-pm-screen-text">'+g+"</div>",j=a('<div class="onp-pm-yandex-payment-form"></div>'),k=d.alternatePaymentTypePageUrl?'<tr><td></td><td><a href="'+d.alternatePaymentTypePageUrl+'" class="onp-pm-pform-alternate-payment-type-link" target="_blank">Не подходит способ оплаты?</a></td></tr>':"",l=a.pandalocker.lang.pl_payment_form_terms.replace("{%terms_url%}",d.termsPageUrl),m='<form method="POST" action="https://money.yandex.ru/quickpay/confirm.xml" target="_blank"><table class="onp-pm-pform-table"><tbody><tr><td>'+a.pandalocker.lang.pl_payment_form_target_label+":</td><td><strong>"+d.targets+"</strong></td></tr><tr><td>"+a.pandalocker.lang.pl_payment_form_price_label+":</td><td><strong>"+d.sum+" руб.</strong></td></tr><tr><td>"+a.pandalocker.lang.pl_payment_form_way_label+':</td><td><label><select name="paymentType"><option value="AC" selected>Банковской картой</option><option value="PC">Яндекс.Деньгами</option></select></label></td></tr>'+k+'</tbody></table><div class="onp-pm-pform-bottom"><div class="onp-pm-pform-bottom-left-side"><label><input type="checkbox" class="onp-pm-payment-terms-checkbox" checked> '+l+' </label></div><div class="onp-pm-pform-bottom-right-side"><input type="submit" class="onp-pm-payment-button" value="Перейти к оплате"></div></div><input type="hidden" name="receiver" value="'+d.receiver+'">		<input type="hidden" name="label" value="'+d.label+'"><input type="hidden" name="quickpay-form" value="'+d.quickpay+'"><input type="hidden" name="targets" value="'+d.targets+'"><input type="hidden" name="sum" value="'+d.sum+'" data-type="number"></form>';f&&b.append(h),g&&b.append(i),b.append(j.append(m));var n=a(".onp-pm-payment-terms-checkbox",b),o=a(".onp-pm-payment-button",b);n.change(function(){a(this).is(":checked")?o.removeClass("disabled"):o.addClass("disabled")}),o.click(function(){if(a(this).hasClass("disabled"))return!1;c._showScreen("data-processing",{screenText:a.pandalocker.lang.pl_payment_form_process});var b=c.options.paylocker&&c.options.paylocker.ajaxUrl;if(b)var e=setInterval(function(){a.ajax({url:b,type:"post",dataType:"json",data:{action:"onp_pl_check_transaction",transactionId:d.label},success:function(a,b,d){(!a||a.error||"cancel"==a.transaction_status)&&(clearInterval(e),c._showScreen("paylocker-error",{errorMessage:a.error})),"finish"==a.transaction_status&&(clearInterval(e),c._showScreen("paylocker-success-payment"))}})},1e4)})})})}(jQuery);